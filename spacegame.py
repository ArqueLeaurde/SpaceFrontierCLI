import random
import time
import sys

class Ressource:
    def __init__(self, nom, quantite):
        self.nom = nom
        self.quantite = quantite

class Planete:
    def __init__(self, nom):
        self.nom = nom
        self.taille = random.randint(7000, 10000)  
        self.ressources = [Ressource("Carburant", random.randint(1, 5))]
        self.colonisee = False
        self.visitee = False
        self.redevance = random.randint(1, 3)  
        self.besoin_carburant = random.randint(1, 5)
        self.besoin_gold = random.randint(5, 10)
        self.prix_carburant = random.randint(2, 6)  
        self.missions = [Mission(random.choice(["Transport", "Chasse", "Collecte"]), random.randint(15, 30), random.randint(0, 9)) for _ in range(2)]

    def coloniser(self, vaisseau):
        if not self.colonisee and vaisseau.carburant >= self.besoin_carburant and vaisseau.space_gold >= self.besoin_gold:
            vaisseau.carburant -= self.besoin_carburant
            vaisseau.space_gold -= self.besoin_gold
            self.colonisee = True
            print(f"La plan√®te {self.nom} est colonis√©e ! Vous gagnez {self.redevance} Galactic Gold par tour.")
        else:
            print(f"Impossible de coloniser {self.nom}. Besoin de {self.besoin_carburant} carburant et {self.besoin_gold} Galactic Gold.")

class Vaisseau:
    def __init__(self):
        self.carburant = 15  
        self.space_gold = 10
        self.ressources = []
        self.efficacite = 1.0 
        self.moteur_eco_niveau = 0  # Max 2 levels
        self.armes_plasma_niveau = 0  # Max 3 levels

    def collecter_ressources(self, planete):
        if planete.ressources:
            for ressource in planete.ressources:
                self.ressources.append(ressource)
            print(f"Ressources collect√©es sur {planete.nom}.")
            planete.ressources = []
            self.space_gold += 5
            print(f"Vous avez gagn√© 5 Galactic Gold pour la collecte.")
        else:
            print("Pas de ressources disponibles.")

    def ameliorer(self):
        print("\nüîß Am√©liorations disponibles :")
        print(f"1. Moteur √©conomique (Niveau {self.moteur_eco_niveau}/2) - R√©duit la consommation de carburant.")
        print(f"   Co√ªt : {20 + self.moteur_eco_niveau * 10} GG")
        print(f"2. Armes √† plasma (Niveau {self.armes_plasma_niveau}/3) - R√©duit l‚Äô√©cart cible en chasse.")
        print(f"   Co√ªt : {25 + self.armes_plasma_niveau * 15} GG")

        choix = input("\nQuel upgrade souhaitez-vous acheter ? (1/2) : ")
        
        if choix == "1" and self.moteur_eco_niveau < 2:
            cost = 20 + self.moteur_eco_niveau * 10
            if self.space_gold >= cost:
                self.space_gold -= cost
                self.moteur_eco_niveau += 1
                self.efficacite *= 0.8  # Less fuel consumption
                print("üöÄ Moteur √©conomique am√©lior√© ! Consommation de carburant r√©duite.")
            else:
                print("‚ùå Pas assez de Galactic Gold !")

        elif choix == "2" and self.armes_plasma_niveau < 3:
            cost = 25 + self.armes_plasma_niveau * 15
            if self.space_gold >= cost:
                self.space_gold -= cost
                self.armes_plasma_niveau += 1
                print("üî´ Armes √† plasma am√©lior√©es ! Viser est plus facile en chasse.")
            else:
                print("‚ùå Pas assez de Galactic Gold !")
        else:
            print("‚ùå Am√©lioration impossible.")


class Mission:
    def __init__(self, type_mission, recompense, cible):
        self.type_mission = type_mission
        self.recompense = recompense
        self.cible = cible

    def accomplir(self, vaisseau, position_actuelle):
        if self.type_mission == "Transport":
            self.minigame_transport(vaisseau)
        elif self.type_mission == "Chasse":
            self.minigame_chasse(vaisseau)
        elif self.type_mission == "Collecte":
            self.minigame_collecte(vaisseau)

    def minigame_transport(self, vaisseau):
        print("üöÄ Mini-jeu Transport : Appuyez sur ENTER lorsque le compteur atteint 0 !")
        
        # Affichage progressif du compteur
        for i in range(3, -1, -1):  
            sys.stdout.write(f"\r‚è≥ {i} ")  # Affichage sur la m√™me ligne
            sys.stdout.flush()
            time.sleep(1)  
        
        print("\nGO!")  
        start_time = time.time()
        input()  # Le joueur appuie sur ENTER
        reaction_time = time.time() - start_time

        if 0.8 <= reaction_time <= 1.2:
            print(f"‚úÖ Mission r√©ussie ! Vous gagnez {self.recompense} Galactic Gold.")
            vaisseau.space_gold += self.recompense
        else:
            print("‚ùå Mission √©chou√©e ! Trop lent ou trop rapide.")
            
    def minigame_chasse(self, vaisseau):
        print("üéØ Mini-jeu Chasse : Trouvez le bon num√©ro entre 1 et 10 !")
        target_range = max(1, 10 - vaisseau.armes_plasma_niveau)  # Reduces target range
        target = random.randint(1, target_range)
        for _ in range(3):
            guess = int(input(f"Votre tir (1-{target_range}) : "))
            if guess == target:
                print(f"üí• Touch√© ! Mission r√©ussie. Vous gagnez {self.recompense} Galactic Gold.")
                vaisseau.space_gold += self.recompense
                return
            else:
                print("‚ùå Rat√© ! Essayez encore.")
        print("üòû Mission √©chou√©e ! Le vaisseau ennemi a fui.")


    def minigame_collecte(self, vaisseau):
        print("üß† Mini-jeu Collecte : M√©morisez cette s√©quence de nombres !")
        sequence = [random.randint(1, 9) for _ in range(5)]
        print("S√©quence : " + " ".join(map(str, sequence)))
        time.sleep(3)
        print("\n" * 50)
        reponse = input("Entrez la s√©quence (s√©par√©e par des espaces) : ").strip()
        if reponse == " ".join(map(str, sequence)):
            print(f"‚úÖ Bonne m√©moire ! Mission r√©ussie. Vous gagnez {self.recompense} Galactic Gold.")
            vaisseau.space_gold += self.recompense
        else:
            print("‚ùå Mauvaise r√©ponse ! Mission √©chou√©e.")

def generer_nom_planete():
    prefixes = ["Zeta", "Alpha", "Gamma", "Delta", "Theta", "Kappa"]
    suffixes = ["Prime", "X", "Beta", "Nova", "Terra"]
    return f"{random.choice(prefixes)} {random.choice(suffixes)}"

def boucle_de_jeu():
    vaisseau = Vaisseau()
    planetes = [Planete(generer_nom_planete()) for _ in range(15)]  # 15 plan√®tes normales
    boss_planete = Planete("Omega Nexus")  # Boss final
    planetes.append(boss_planete)  # Ajout en derni√®re position
    position_actuelle = 0
    distance_seuil_boss = 12  # Distance avant de n'avoir que le boss en option

    while vaisseau.carburant > 0:
        # Calcul des revenus passifs bas√©s sur les plan√®tes colonis√©es
        revenu_passif = sum(p.redevance for p in planetes if p.colonisee)
        planete = planetes[position_actuelle]
        print(f"\nüöÄ Vous √™tes sur {planete.nom}. ‚õΩ Carburant: {vaisseau.carburant} | üí∞ Galactic Gold: {vaisseau.space_gold} (+{revenu_passif} GG/tour)")
        planete.visitee = True

        print(f"1. Prendre une mission")
        print(f"2. Coloniser {planete.nom}" if not planete.colonisee else "")
        print(f"3. Collecter des ressources")
        print(f"4. Voyager vers une autre plan√®te")
        print(f"5. Acheter du carburant ({planete.prix_carburant} GG/unit√©)")
        print(f"6. Am√©liorer le vaisseau")

        choix = input("Votre action : ")
        action_effectuee = False  # ‚úÖ Permet de g√©rer les gains correctement

        if choix == "1":
            if planete.missions:
                mission = planete.missions.pop(0)
                mission.accomplir(vaisseau, position_actuelle)
                action_effectuee = True  # ‚úÖ Une mission a √©t√© effectu√©e
            else:
                print("Aucune mission disponible.")

        elif choix == "2" and not planete.colonisee:
            planete.coloniser(vaisseau)
            action_effectuee = True  # ‚úÖ Colonisation effectu√©e

        elif choix == "3":
            vaisseau.collecter_ressources(planete)
            action_effectuee = True  # ‚úÖ Ressources collect√©es

        elif choix == "4":
            print("\nüåç Plan√®tes disponibles pour le voyage :")
            destinations_possibles = []

            if position_actuelle >= distance_seuil_boss:
                print("\n‚ö†Ô∏è  Une pr√©sence myst√©rieuse perturbe les syst√®mes du vaisseau...")
                time.sleep(2)
                print("üì° Un signal inconnu intercepte vos communications...")
                time.sleep(2)
                print(f"üî¥ Destination verrouill√©e : {boss_planete.nom} (Distance: {abs(len(planetes) - 1 - position_actuelle)})")
                destinations_possibles.append(len(planetes) - 1) # Uniquement le boss
            else:
                distances = random.sample(range(1, 4), min(3, len(planetes) - position_actuelle - 1))
                for d in distances:
                    destination_index = min(position_actuelle + d, len(planetes) - 1)
                    destinations_possibles.append(destination_index)

                for i, idx in enumerate(destinations_possibles):
                    print(f"{i}. {planetes[idx].nom} (Distance: {abs(idx - position_actuelle)})")

            choix_planete = int(input("\nüî≠ Entrez le num√©ro de la plan√®te cible : "))
            if 0 <= choix_planete < len(destinations_possibles):
                cible = destinations_possibles[choix_planete]
                cout = int(abs(cible - position_actuelle) * vaisseau.efficacite)

                if vaisseau.carburant >= cout:
                    print("\nüöÄ Pr√©paration au d√©collage...")
                    time.sleep(1)
                    print("\n‚ú® Voyage interstellaire en cours...\n")
                    time.sleep(1)

                    print(f"\nüåç Arriv√©e sur {planetes[cible].nom} !")
                    position_actuelle = cible
                    vaisseau.carburant -= cout
                    action_effectuee = True  # ‚úÖ Voyage effectu√©
                else:
                    print("‚õΩ Pas assez de carburant pour ce voyage !")

        elif choix == "5":
            max_achat = vaisseau.space_gold // planete.prix_carburant
            if max_achat > 0:
                quantite = int(input(f"Combien d'unit√©s de carburant souhaitez-vous acheter ? (Max {max_achat}) : "))
                if 0 < quantite <= max_achat:
                    vaisseau.space_gold -= quantite * planete.prix_carburant
                    vaisseau.carburant += quantite
                    print(f"‚õΩ Vous avez achet√© {quantite} unit√©s de carburant.")
                    action_effectuee = True  # ‚úÖ Achat effectu√©
                else:
                    print("‚ùå Achat annul√© ou quantit√© invalide.")
            else:
                print("‚ùå Pas assez de Galactic Gold pour acheter du carburant !")

        elif choix == "6":
            vaisseau.ameliorer()
            action_effectuee = True  # ‚úÖ Am√©lioration effectu√©e

        # ‚úÖ Appliquer les revenus des plan√®tes colonis√©es **seulement si une action a √©t√© faite**
        if action_effectuee:
            for p in planetes:
                if p.colonisee:
                    vaisseau.space_gold += p.redevance

    print("üí• Plus de carburant ! Fin du jeu.")


def combat_final(vaisseau):
    print("\n‚ö†Ô∏è ALERTE : Vous √™tes arriv√© sur Omega Nexus !")
    print("Un ennemi redoutable, le Seigneur Galactique Xypher, vous attend pour un combat final ! ‚öîÔ∏è")
    
    boss_hp = 50
    joueur_hp = 30 + vaisseau.armes_plasma_niveau * 5  # Plus d'am√©liorations = plus de vie
    boss_attack_counter = 0  # Pour g√©rer les attaques sp√©ciales du boss

    while boss_hp > 0 and joueur_hp > 0:
        print(f"\nüî• Xypher: {boss_hp} HP  |  üõ°Ô∏è Votre vaisseau: {joueur_hp} HP")
        print("1. Attaque laser (5-10 d√©g√¢ts)")
        print("2. Tir plasma (7-15 d√©g√¢ts, plus efficace avec am√©lioration)")
        print("3. D√©fense (r√©duit les d√©g√¢ts du boss)")
        print("4. Attaque sp√©ciale (Peut infliger 20-30 d√©g√¢ts mais consomme des ressources)")

        choix = input("Que faites-vous ? ")

        if choix == "1":
            degats = random.randint(5, 10)
            boss_hp -= degats
            print(f"üí• Vous infligez {degats} d√©g√¢ts !")
        elif choix == "2":
            degats = random.randint(7, 15) + vaisseau.armes_plasma_niveau * 2
            boss_hp -= degats
            print(f"üî´ Vous infligez {degats} d√©g√¢ts avec vos armes √† plasma !")
        elif choix == "3":
            print("üõ°Ô∏è Vous vous prot√©gez, r√©duisant les d√©g√¢ts du boss ce tour.")
            joueur_hp += 5  # Un petit bonus de d√©fense
        elif choix == "4":
            if vaisseau.space_gold >= 10:  # Consomme des Galactic Gold pour activer l'attaque sp√©ciale
                vaisseau.space_gold -= 10
                degats = random.randint(20, 30)
                boss_hp -= degats
                print(f"‚ö° Attaque sp√©ciale ! Vous infligez {degats} d√©g√¢ts √† Xypher !")
            else:
                print("‚ùå Pas assez de Galactic Gold pour utiliser l'attaque sp√©ciale.")
        else:
            print("‚ùå Choix invalide !")
            continue

        # Attaque du boss
        boss_degats = random.randint(5, 12)
        joueur_hp -= boss_degats
        print(f"üíÄ Xypher vous attaque et inflige {boss_degats} d√©g√¢ts !")
        
        # Si le boss est √† moins de 20% de sa vie, il passe √† la phase 2
        if boss_hp <= 10 and boss_attack_counter == 0:
            print("\n‚ö†Ô∏è Phase 2 : Xypher se transforme ! Ses attaques sont plus puissantes !")
            boss_attack_counter += 1  # On passe √† la phase 2

            # Augmenter les d√©g√¢ts de Xypher et lui donner des capacit√©s sp√©ciales
            boss_degats += 3  # Augmenter les d√©g√¢ts de Xypher

        if joueur_hp <= 0:
            print("\nüíÄ GAME OVER... Xypher a d√©truit votre vaisseau.")
            break

    if joueur_hp > 0:
        print("\nüèÜ üéâ VICTOIRE ! Vous avez vaincu Xypher et sauv√© la galaxie !")


boucle_de_jeu()